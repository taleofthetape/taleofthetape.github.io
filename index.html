<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily UFCle: Guess the Fighter</title>
    <style>
        /* Basic Styling and Layout (You have full freedom to style this) */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: #f4f4f4; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1 { color: #f00; text-align: center; margin-bottom: 20px; }
        .input-area { display: flex; gap: 10px; margin-bottom: 20px; }
        #fighter-input { flex-grow: 1; padding: 10px; border: 2px solid #ccc; border-radius: 5px; }
        #guess-button { background-color: #f00; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; }
        #guess-button:hover { background-color: #cc0000; }
        .results-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .results-table th, .results-table td { padding: 10px; border: 1px solid #ddd; text-align: center; }
        .results-table th { background-color: #eee; }
        
        /* Color Coding for Results */
        .color-red { background-color: #ffcccc; color: #a00; }    /* Far off */
        .color-yellow { background-color: #fffacd; color: #a90; } /* Closer */
        .color-green { background-color: #ccffcc; color: #0a0; }  /* Correct */
        
        /* Arrow Styling */
        .arrow { font-size: 1.2em; margin-left: 5px; }
        .up-arrow { color: #f00; } /* Secret fighter is HIGHER */
        .down-arrow { color: #f00; } /* Secret fighter is LOWER */

        .status-message { text-align: center; font-weight: bold; margin-top: 20px; padding: 10px; border-radius: 5px; }
        .win { background-color: #ccffcc; color: #0a0; }
        .lose { background-color: #ffcccc; color: #a00; }

        /* Autocomplete List */
        .autocomplete-list { position: absolute; background: white; border: 1px solid #ccc; max-height: 200px; overflow-y: auto; z-index: 100; width: calc(800px - 40px); }
        .autocomplete-item { padding: 10px; cursor: pointer; display: flex; align-items: center; border-bottom: 1px solid #eee; }
        .autocomplete-item:hover { background: #f0f0f0; }
        .autocomplete-item img { width: 30px; height: 30px; border-radius: 50%; margin-right: 10px; object-fit: cover; }

        /* Footer */
        .footer { text-align: center; margin-top: 30px; font-size: 0.8em; color: #888; }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ðŸ¥Š UFCle: Guess the Fighter</h1>
    </header>

    <div id="game-info">
        <p>Guess the mystery UFC fighter in 5 attempts!</p>
        <p id="guesses-remaining">Guesses Remaining: 5</p>
    </div>

    <div class="input-area">
        <input type="text" id="fighter-input" placeholder="Start typing a fighter's name...">
        <button id="guess-button">Guess</button>
        <button id="practice-button">Practice Game</button>
    </div>
    <div id="autocomplete-container"></div>

    <div id="results">
        <table class="results-table">
            <thead>
                <tr>
                    <th>Fighter</th>
                    <th>Division</th>
                    <th>Rank</th>
                    <th>Record</th>
                    <th>SLpM</th>
                    <th>SApM</th>
                    <th>TD Avg</th>
                    <th>Sub Avg</th>
                    <th>Fight Time</th>
                </tr>
            </thead>
            <tbody id="guesses-tbody">
                </tbody>
        </table>
    </div>

    <div id="status" class="status-message"></div>
</div>

<footer class="footer">
    Game created by <a href="https://github.com/zwinship" target="_blank">zwinship</a>. Data updated daily via GitHub Actions.
</footer>

<script>
    // --- Global Game State ---
    let GAME_STATE = {
        dailyFighter: null,
        allFighters: {},
        guesses: [],
        maxGuesses: 5,
        isGameOver: false,
        isPracticeMode: false
    };

    // --- Key Fighter Stats for Comparison (Numeric and need comparison logic) ---
    // Stat Name: [Display Name, Unit Conversion Multiplier]
    const COMPARISON_STATS = {
        'SLpM': 'SLpM',
        'SApM': 'SApM',
        'TD_Avg': 'TD Avg',
        'Sub_Avg': 'Sub Avg',
        'Fight_Time_Seconds': 'Fight Time'
    };
    
    // --- Non-Comparison Stats (Check for exact match) ---
    const EXACT_MATCH_STATS = ['Division', 'Rank', 'Stance'];

    // --- Utility Functions ---

    /** Fetches data from the JSON file. */
    async function fetchGameData() {
        try {
            // Append a timestamp to prevent caching, especially important for the daily update
            const response = await fetch('game_data.json?' + new Date().getTime());
            const data = await response.json();
            
            // Convert fight time string (e.g., "05:00") to seconds for comparison
            for (const name in data.fighter_data) {
                const fighter = data.fighter_data[name];
                fighter.Fight_Time_Seconds = timeToSeconds(fighter.Fight_Time);
            }

            GAME_STATE.allFighters = data.fighter_data;
            // Determine the fighter to guess: use the daily fighter unless in practice mode
            const dailyFighterName = data.daily_fighter?.Name;
            if (dailyFighterName && GAME_STATE.allFighters[dailyFighterName]) {
                 GAME_STATE.dailyFighter = GAME_STATE.allFighters[dailyFighterName];
            } else {
                 console.error("Could not load daily fighter data. Starting practice mode by default.");
                 startPracticeGame();
                 return;
            }
            console.log("Game data loaded. Daily Fighter is set.");
        } catch (error) {
            console.error("Error fetching or processing game data:", error);
            document.getElementById('status').textContent = "Error loading game data. Please check back later.";
            GAME_STATE.isGameOver = true;
        }
    }

    /** Converts 'MM:SS' time string to total seconds (for math comparisons). */
    function timeToSeconds(timeStr) {
        if (!timeStr || timeStr === 'N/A') return 0;
        const parts = timeStr.split(':');
        if (parts.length === 2) {
            return parseInt(parts[0]) * 60 + parseInt(parts[1]);
        }
        return parseFloat(timeStr) || 0; // fallback for non-MM:SS formats
    }

    /** Gets the comparison value for a stat (number or 0 if N/A). */
    function getStatValue(fighter, statKey) {
        const val = fighter[statKey];
        if (statKey === 'Fight_Time_Seconds') {
            return parseFloat(val) || 0;
        }
        // Handle numeric stats which might be strings
        return parseFloat(val) || 0;
    }

    /** Clears and resets the game state for a new daily or practice game. */
    function resetGame() {
        GAME_STATE.guesses = [];
        GAME_STATE.isGameOver = false;
        document.getElementById('guesses-tbody').innerHTML = '';
        document.getElementById('status').innerHTML = '';
        document.getElementById('fighter-input').value = '';
        updateGuessesRemaining();
    }

    /** Starts a practice game with a random fighter. */
    function startPracticeGame() {
        resetGame();
        GAME_STATE.isPracticeMode = true;
        const fighterNames = Object.keys(GAME_STATE.allFighters);
        const randomName = fighterNames[Math.floor(Math.random() * fighterNames.length)];
        GAME_STATE.dailyFighter = GAME_STATE.allFighters[randomName];
        document.getElementById('status').textContent = `Starting Practice Game! Guess the fighter.`;
        console.log(`Practice fighter is: ${randomName}`);
    }

    /** Updates the displayed number of guesses left. */
    function updateGuessesRemaining() {
        const remaining = GAME_STATE.maxGuesses - GAME_STATE.guesses.length;
        document.getElementById('guesses-remaining').textContent = `Guesses Remaining: ${remaining}`;
        if (remaining === 0 && !GAME_STATE.isGameOver) {
            endGame(false);
        }
    }


    // --- Game Logic ---

    /** Handles the main guess submission. */
    function handleGuess() {
        if (GAME_STATE.isGameOver) return;

        const inputEl = document.getElementById('fighter-input');
        const guessName = inputEl.value.trim();
        
        // Find the fighter object based on the name from the full list
        const guessedFighter = Object.values(GAME_STATE.allFighters).find(f => f.Name.toLowerCase() === guessName.toLowerCase());

        if (!guessedFighter) {
            alert("Please select a valid fighter from the list.");
            return;
        }

        if (GAME_STATE.guesses.includes(guessName)) {
            alert("You have already guessed this fighter.");
            return;
        }

        // Add to guesses and process
        GAME_STATE.guesses.push(guessName);
        processGuess(guessedFighter);
        inputEl.value = ''; // Clear input field

        if (guessedFighter.Name === GAME_STATE.dailyFighter.Name) {
            endGame(true);
        } else {
            updateGuessesRemaining();
            if (GAME_STATE.guesses.length >= GAME_STATE.maxGuesses) {
                endGame(false);
            }
        }
    }

    /** Compares the guessed fighter's stats to the secret fighter's stats. */
    function processGuess(guessedFighter) {
        const secret = GAME_STATE.dailyFighter;
        let rowHtml = `<tr>`;
        let allStatsCorrect = true;

        // 1. Fighter Name and Picture (First Column)
        const picUrl = guessedFighter.Picture_URL || 'N/A';
        rowHtml += `<td><div style="display:flex;align-items:center;"><img src="${picUrl}" style="width: 30px; height: 30px; border-radius: 50%; margin-right: 5px;">${guessedFighter.Name}</div></td>`;

        // 2. Division & Rank (Exact Match)
        ['Division', 'Rank'].forEach(stat => {
            let className = '';
            if (guessedFighter[stat] === secret[stat]) {
                className = 'color-green';
            }
            rowHtml += `<td class="${className}">${guessedFighter[stat]}</td>`;
            if (guessedFighter[stat] !== secret[stat]) {
                allStatsCorrect = false;
            }
        });

        // 3. Comparison Stats (Numeric/Arrow)
        for (const statKey in COMPARISON_STATS) {
            const guessVal = getStatValue(guessedFighter, statKey);
            const secretVal = getStatValue(secret, statKey);

            let className = '';
            let arrowHtml = '';

            // Calculate difference for color scale (Red: Far, Yellow: Closer, Green: Exact)
            if (guessVal === secretVal) {
                className = 'color-green';
            } else if (secretVal === 0) { // If secret fighter stat is N/A, can't compare
                className = 'color-yellow'; 
                arrowHtml = '';
            } else {
                allStatsCorrect = false;

                const diff = Math.abs(guessVal - secretVal);
                const isHigher = guessVal > secretVal;

                // Threshold logic (arbitrary example, can be fine-tuned)
                // Use a percentage difference for a better scale
                const percentageDiff = diff / secretVal;
                
                if (percentageDiff > 0.5) {
                    className = 'color-red'; // More than 50% off
                } else if (percentageDiff > 0.1) {
                    className = 'color-yellow'; // More than 10% off
                } else {
                    className = 'color-yellow'; // 10% or less off
                }

                // Add arrow
                arrowHtml = isHigher 
                    ? '<span class="arrow up-arrow">â–²</span>' // Guess is higher, secret is lower
                    : '<span class="arrow down-arrow">â–¼</span>'; // Guess is lower, secret is higher
            }

            // Display value (revert fight time back to MM:SS for display)
            let displayVal = guessedFighter[statKey];
            if (statKey === 'Fight_Time_Seconds') {
                const minutes = Math.floor(displayVal / 60);
                const seconds = displayVal % 60;
                displayVal = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }

            rowHtml += `<td class="${className}">${displayVal} ${arrowHtml}</td>`;
        }
        
        // 4. Record (Exact match, but only for display consistency)
        rowHtml += `<td>${guessedFighter.Record}</td>`;

        rowHtml += `</tr>`;
        
        // Insert the new guess row at the top of the table body
        document.getElementById('guesses-tbody').insertAdjacentHTML('afterbegin', rowHtml);
    }

    /** Ends the game (win or loss). */
    function endGame(isWin) {
        GAME_STATE.isGameOver = true;
        const statusEl = document.getElementById('status');
        const dailyFighterName = GAME_STATE.dailyFighter.Name;

        if (isWin) {
            statusEl.className = 'status-message win';
            statusEl.innerHTML = `ðŸŽ‰ **CORRECT!** You guessed the fighter: **${dailyFighterName}**! ðŸŽ‰`;
            // Simple confetti effect (can be replaced with a library)
            document.body.style.backgroundColor = '#ccffcc';
            setTimeout(() => document.body.style.backgroundColor = '#f4f4f4', 3000);
        } else {
            statusEl.className = 'status-message lose';
            statusEl.innerHTML = `âŒ **GAME OVER!** The fighter was **${dailyFighterName}**. Better luck tomorrow!`;
        }

        document.getElementById('guess-button').disabled = true;
        document.getElementById('fighter-input').disabled = true;
    }


    // --- Autocomplete Functionality ---

    function setupAutocomplete() {
        const inputEl = document.getElementById('fighter-input');
        const containerEl = document.getElementById('autocomplete-container');

        inputEl.addEventListener('input', function() {
            const val = this.value.toLowerCase();
            containerEl.innerHTML = ''; // Clear previous list
            if (!val) return;

            const matches = Object.values(GAME_STATE.allFighters)
                .filter(fighter => fighter.Name.toLowerCase().includes(val))
                .slice(0, 10); // Limit to 10 results

            if (matches.length === 0) return;

            const listEl = document.createElement('div');
            listEl.className = 'autocomplete-list';
            
            matches.forEach(fighter => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                // Add picture if available
                const picUrl = fighter.Picture_URL || ''; 
                item.innerHTML = `<img src="${picUrl}" onerror="this.style.display='none'" alt="${fighter.Name}"><span>${fighter.Name}</span>`;
                
                item.addEventListener('click', () => {
                    inputEl.value = fighter.Name;
                    containerEl.innerHTML = '';
                    handleGuess(); // Optionally auto-guess on click
                });
                listEl.appendChild(item);
            });

            containerEl.appendChild(listEl);
        });

        // Close the autocomplete list when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target !== inputEl) {
                containerEl.innerHTML = '';
            }
        });
    }

    // --- Initialization ---

    document.addEventListener('DOMContentLoaded', async () => {
        await fetchGameData();
        setupAutocomplete();
        document.getElementById('guess-button').addEventListener('click', handleGuess);
        document.getElementById('practice-button').addEventListener('click', startPracticeGame);

        // Allow pressing Enter in the input field to submit
        document.getElementById('fighter-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('guess-button').click();
            }
        });
    });

</script>
</body>
</html>
